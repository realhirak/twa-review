<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icon.png" />
  <title>Review My TWA</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Product+Sans&display=swap');

    body {
      font-family: 'Product Sans', Arial, sans-serif;
      background-color: #fff;
      color: #111827;
      margin: 0;
      height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    .rtwa-popup {
      width: 100%;
      max-width: 768px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgb(0 0 0 / 0.05);
      background-color: #fff;
      overflow: hidden;
      position: fixed;
      bottom: 0px;
      padding-bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      color: #111827;
    }

     @media (min-width: 40rem) {
      .rtwa-popup {
        border-radius: 10px;
        bottom: 1rem;
        padding-bottom: 5px;
        max-width: 400px;
        left: auto;
        right: 1rem;
        transform: none;
      }
    }

    .rtwa-header {
      border-bottom: 1px solid #e5e7eb;
      background-color: #fff;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #111827;
    }

    .rtwa-header-left,
    .rtwa-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rtwa-header-left img,
    .rtwa-header-right img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .rtwa-header-right img {
      width: 32px;
      height: 32px;
      border-radius: 9999px;
    }

    .rtwa-header-left span {
      color: #4b5563;
      font-size: 1.3rem;
      font-weight: 400;
    }

    .rtwa-header-right span {
      color: #111827;
      font-weight: 400;
      font-size: 1rem;
    }

    .rtwa-content {
      padding: 12px 16px;
      background-color: #fff;
      color: #111827;
    }

    .rtwa-app-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .rtwa-app-icon {
      width: 40px;
      height: 40px;
      background-color: #fcd34d;
      border-radius: 8px;
      object-fit: contain;
    }

    .rtwa-app-text {
      max-width: 400px;
    }

    .rtwa-app-text p:first-child {
      font-weight: 500;
      color: #111827;
      font-size: 1.1rem;
      line-height: 1.25rem;
      margin: 0;
    }

    .rtwa-app-text p:last-child {
      font-weight: 400;
      color: #6b7280;
      font-size: 0.95rem;
      line-height: 1rem;
      margin: 0;
      padding: 6px 0 4px 0;
    }

    .rtwa-stars {
      display: flex;
      gap: 12px;
      margin: 23px 0 30px 0;
    }

    
    @media (min-width: 40rem) {
      .rtwa-stars {
        margin: 14px 0 20px 0;
      }
    }

    .rtwa-star-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      width: 40px;
      height: 40px;
      stroke: #c3c6cc;
      transition: fill 0.2s ease;
    }

    .rtwa-star-button svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .rtwa-actions {
      display: flex;
      gap: 16px;
    }

    .rtwa-btn {
      flex: 1;
      padding: 10px 0;
      font-weight: 600;
      font-size: 0.875rem;
      border-radius: 0.375rem;
      cursor: pointer;
      border: 1px solid transparent;
      transition: background-color 0.2s ease;
    }

    .rtwa-btn-cancel {
      border-color: #d1d5db;
      color: #047857;
      background-color: #fff;
    }

    .rtwa-btn-cancel:hover {
      background-color: #e3fff0;
    }

    .rtwa-btn-submit {
      background-color: #047857;
      color: #fff;
      border-color: #047857;
    }

    .rtwa-btn-submit:hover {
      background-color: #065f46;
      border-color: #065f46;
    }

    .text-center {
      text-align: center;
    }

    .justify-center {
      justify-content: center;
    }

    .pointer-events-none {
      pointer-events: none;
    }

    .select-none {
      user-select: none;
    }

    .rtwa-popup-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }

    /* Dark mode styles */
    .dark body {
      background-color: #121212;
      color: #d1d5db;
    }

    .dark .rtwa-popup {
      background-color: #1e1e1e;
      border-color: #374151;
      box-shadow: 0 1px 4px rgb(0 0 0 / 0.7);
      color: #d1d5db;
    }

    .dark .rtwa-header {
      background-color: #1e1e1e;
      border-color: #374151;
      color: #d1d5db;
    }

    .dark .rtwa-header-left span {
      color: #9ca3af;
    }

    .dark .rtwa-header-right span {
      color: #d1d5db;
    }

    .dark .rtwa-content {
      background-color: #1e1e1e;
      color: #d1d5db;
    }

    .dark .rtwa-app-text p:first-child {
      color: #d1d5db;
    }

    .dark .rtwa-app-text p:last-child {
      color: #9ca3af;
    }

    .dark .rtwa-app-icon {
      background-color: #b59f3b;
    }

    .dark .rtwa-star-button svg {
      stroke: #6b7280;
    }

    .dark .rtwa-btn-cancel {
      border-color: #4b5563;
      color: #34d399;
      background-color: #121212;
    }

    .dark .rtwa-btn-cancel:hover {
      background-color: #27272a;
    }

    .dark .rtwa-btn-submit {
      background-color: #059669;
      border-color: #059669;
      color: #ffffff;
    }

    .dark .rtwa-btn-submit:hover {
      background-color: #047857;
      border-color: #047857;
    }

    .dark .rtwa-popup-backdrop {
      background-color: rgba(0, 0, 0, 0.6);
    }
  </style>
</head>

<body>

<p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Iste et omnis aperiam hic quam autem cumque, architecto
  voluptate sequi odio harum quibusdam itaque repellat voluptatum ullam, nam nesciunt, iure sint.</p>
<div class="rtwa-popup-backdrop" aria-hidden="true">

  <div class="rtwa-popup" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
    <div class="rtwa-header">
      <div class="rtwa-header-left pointer-events-none select-none">
        <img src="visual-identity_logos_880x572-3.width-1440.format-webp.webp" alt="Google Play logo" width="24"
          height="24" />
        <span>Google Play</span>
      </div>

    </div>
    <div class="rtwa-content">
      <div class="rtwa-app-info pointer-events-none select-none">
        <img src="https://play-lh.googleusercontent.com/8Nu3gtUhArD8efOANJTSAyo9vuM_ZxRHENwHPmgFlVp2bgAzqJyhWpF-jLPF99I2LOao=w480-h960-rw"
          alt="App icon" class="rtwa-app-icon" width="40" height="40" />
        <div class="rtwa-app-text">
          <p id="rtwa-app-title-text">Instagram</p>
          <p id="rtwa-app-desc-text">Enjoying this app? Rate and help us improve with a review.
          </p>
        </div>
      </div>


      <div class="rtwa-stars text-center justify-center" role="radiogroup" aria-label="Star rating">
        <button aria-label="Star 1" class="rtwa-star-button" type="button" tabindex="0" aria-pressed="false">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"
            aria-hidden="true" focusable="false">
            <polygon
              points="12 17.27 18.18 21 15.64 13.97 21 9.24 13.81 8.63 12 2 10.19 8.63 3 9.24 8.36 13.97 5.82 21 12 17.27" />
          </svg>
        </button>
        <button aria-label="Star 2" class="rtwa-star-button" type="button" tabindex="0" aria-pressed="false">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"
            aria-hidden="true" focusable="false">
            <polygon
              points="12 17.27 18.18 21 15.64 13.97 21 9.24 13.81 8.63 12 2 10.19 8.63 3 9.24 8.36 13.97 5.82 21 12 17.27" />
          </svg>
        </button>
        <button aria-label="Star 3" class="rtwa-star-button" type="button" tabindex="0" aria-pressed="false">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"
            aria-hidden="true" focusable="false">
            <polygon
              points="12 17.27 18.18 21 15.64 13.97 21 9.24 13.81 8.63 12 2 10.19 8.63 3 9.24 8.36 13.97 5.82 21 12 17.27" />
          </svg>
        </button>
        <button aria-label="Star 4" class="rtwa-star-button" type="button" tabindex="0" aria-pressed="false">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"
            aria-hidden="true" focusable="false">
            <polygon
              points="12 17.27 18.18 21 15.64 13.97 21 9.24 13.81 8.63 12 2 10.19 8.63 3 9.24 8.36 13.97 5.82 21 12 17.27" />
          </svg>
        </button>
        <button aria-label="Star 5" class="rtwa-star-button" type="button" tabindex="0" aria-pressed="false">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"
            aria-hidden="true" focusable="false">
            <polygon
              points="12 17.27 18.18 21 15.64 13.97 21 9.24 13.81 8.63 12 2 10.19 8.63 3 9.24 8.36 13.97 5.82 21 12 17.27" />
          </svg>
        </button>
      </div>
      <div class="rtwa-actions">
        <button id="rtwa-later-text" class="rtwa-btn rtwa-btn-cancel" type="button">Maybe later</button>
        <button id="rtwa-review-text" class="rtwa-btn rtwa-btn-submit" type="submit">Review</button>
      </div>
    </div>
  </div>
</div>


<script>

  const ReviewMyTWA = (() => {
  const defaultShowAfter = 3;
  let _isTWA = false;
  let _showAfterDays = defaultShowAfter;
  let _packageName = null;

  async function fetchPackageName() {
    try {
      const res = await fetch('/.well-known/assetlinks.json');
      const json = await res.json();
      const first = json?.[0];
      _packageName = first?.target?.package_name || null;
    } catch (e) {
      console.warn('[ReviewMyTWA] Unable to fetch assetlinks.json for package name detection.', e);
    }
  }

  function baseDetection() {
    return (
      typeof window !== "undefined" &&
      (window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true)
    );
  }

  function matchAnyTWAConditions() {
    const hasUTM = window.location.search.includes("utm_source=twa");
    const hasReferrer = _packageName && document.referrer.includes(`android-app://${_packageName}`);
    const hasLocal = localStorage.getItem("isTWA") === "true";

    return hasUTM || hasReferrer || hasLocal;
  }

  async function detectTWA() {
    if (window.location.search.includes("utm_source=pwa")) {
    _isTWA = false;
    return;
    }
    
    await fetchPackageName();

    if (baseDetection() && matchAnyTWAConditions()) {
      _isTWA = true;
      localStorage.setItem("isTWA", "true");
      updateInternalLinks();
    } else {
      _isTWA = false;
    }
  }

  function isTWA() {
    return _isTWA;
  }

  function updateInternalLinks() {
    const anchors = document.querySelectorAll("a[href^='/'], a[href^='" + location.origin + "']");
    anchors.forEach(a => {
      try {
        const url = new URL(a.href, location.origin);
        if (!url.searchParams.has("utm_medium")) {
          url.searchParams.set("utm_medium", "twa");
          a.href = url.toString();
        }
      } catch (e) {
        console.warn('[ReviewMyTWA] Skipped malformed link:', a.href);
      }
    });
  }

  function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + "=" + encodeURIComponent(value) + "; expires=" + expires + "; path=/";
  }

  function getCookie(name) {
    return document.cookie.split("; ").reduce((r, v) => {
      const parts = v.split("=");
      return parts[0] === name ? decodeURIComponent(parts[1]) : r;
    }, "");
  }

  function daysSinceInstall() {
    const key = "rtwa_install_date";
    let storedDate = localStorage.getItem(key);
    if (!storedDate) {
      const now = Date.now();
      localStorage.setItem(key, now);
      return 0;
    }
    const diff = Date.now() - parseInt(storedDate, 10);
    return Math.floor(diff / 864e5);
  }

  function showReviewDialog() {
    const el = document.querySelector(".rtwa-popup-backdrop");
    if (el) el.style.display = "flex";
  }

  function hideReviewDialog() {
    const el = document.querySelector(".rtwa-popup-backdrop");
    if (el) el.style.display = "none";
  }

  function shouldShowDialog() {
    if (!isTWA()) return false;
    if (localStorage.getItem("appReviewed") === "true") return false;
    if (getCookie("maybeLaterClicked")) return false;
    if (daysSinceInstall() < _showAfterDays) return false;
    return true;
  }

  function initListeners() {
    const backdrop = document.querySelector(".rtwa-popup-backdrop");
    if (!backdrop) return;

    backdrop.querySelectorAll(".rtwa-star-button").forEach(btn => {
      btn.addEventListener("click", () => {
        localStorage.setItem("appReviewed", "true");
        hideReviewDialog();
      });
    });

    const reviewBtn = document.getElementById("rtwa-review-text");
    if (reviewBtn) {
      reviewBtn.addEventListener("click", () => {
        localStorage.setItem("appReviewed", "true");
        hideReviewDialog();
      });
    }

    const maybeLaterBtn = document.getElementById("rtwa-later-text");
    if (maybeLaterBtn) {
      maybeLaterBtn.addEventListener("click", () => {
        setCookie("maybeLaterClicked", "true", 7);
        hideReviewDialog();
      });
    }
  }

  function showAfter(days) {
    const n = parseInt(days, 10);
    if (!isNaN(n) && n >= 1 && n <= 90) {
      _showAfterDays = n;
    } else {
      _showAfterDays = defaultShowAfter;
    }
  }

  async function init() {
    await detectTWA();
    if (shouldShowDialog()) {
      showReviewDialog();
    }
    initListeners();
  }

  document.addEventListener("DOMContentLoaded", init);

  return {
    isTWA,
    showAfter,
    showReviewDialog,
    hideReviewDialog,
  };
})();

</script>

<script>
  // Example usage
  ReviewMyTWA.showAfter(7); // Show dialog after 7 days
</script>

</body>

</html>
